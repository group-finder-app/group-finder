<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Grouper ‚Äì Student Collaboration</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Fraunces:wght@700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/styles.css">
  <style>
    /*  All pages hidden by default; .active shows them  */
    .page {
      display: none !important;
      flex-direction: column;
      height: 100%;
      overflow: hidden;
    }
    .page.active {
      display: flex !important;
    }

    /* Tab panels within main shell*/
    .tab-panel {
      display: none;
      flex-direction: column;
      flex: 1;
      overflow: hidden;
    }
    .tab-panel.active {
      display: flex;
    }

    /*  Filter panel  */
    #filter-panel {
      display: none;
      background: var(--white);
      border-top: 1px solid var(--grey-5);
      padding: 12px 16px;
    }
    #filter-panel.open { display: block; }
    #filter-panel input {
      width: 100%;
      padding: 10px 14px;
      border: 1.5px solid var(--grey-5);
      border-radius: var(--radius-md);
      font-family: var(--font-body);
      font-size: 14px;
      margin-bottom: 10px;
      box-sizing: border-box;
    }
    #filter-panel input:focus { outline: none; border-color: var(--purple); }
    .filter-actions { display: flex; gap: 8px; }

    /* Notification panel  */
    .notif-panel {
      display: none;
      position: absolute;
      top: 72px; right: 16px;
      width: 272px;
      background: var(--white);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-lg);
      z-index: 30;
      border: 1px solid var(--grey-5);
      overflow: hidden;
    }
    .notif-panel.open { display: block; }
    .notif-panel-header {
      padding: 12px 14px;
      font-size: 13px;
      font-weight: 700;
      color: var(--grey-2);
      border-bottom: 1px solid var(--grey-5);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .notif-item {
      padding: 12px 14px;
      border-bottom: 1px solid var(--grey-5);
      cursor: pointer;
    }
    .notif-item:last-child { border-bottom: none; }
    .notif-item:hover { background: var(--grey-6); }
    .notif-item-title { font-size: 13px; font-weight: 600; margin-bottom: 2px; }
    .notif-item-sub   { font-size: 12px; color: var(--grey-3); }
    .notif-badge { background: #e74c3c; color: white; font-size: 10px; font-weight: 700; padding: 2px 7px; border-radius: 10px; }

    /* Join modal */
    #join-modal { display: none; }
    #join-modal.open { display: flex; }

    /* Settings panel  */
    #settings-panel {
      display: none;
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(26,26,46,0.5);
      z-index: 40;
      align-items: flex-end;
    }
    #settings-panel.open { display: flex; }
    .settings-sheet {
      background: var(--white);
      width: 100%;
      border-radius: var(--radius-xl) var(--radius-xl) 0 0;
      padding: 24px 22px 40px;
    }
    .settings-row {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 14px 0;
      border-bottom: 1px solid var(--grey-5);
      font-size: 15px;
      font-weight: 500;
      cursor: pointer;
      color: var(--grey-1);
      transition: color 0.15s;
    }
    .settings-row:last-child { border-bottom: none; }
    .settings-row:hover { color: var(--purple); }
    .settings-row.danger { color: var(--red); }
    .settings-row.danger:hover { color: #a93226; }
    .settings-icon { font-size: 20px; width: 28px; text-align: center; }

    /* Profile banner: relative for gear button */
    .profile-banner { position: relative; }
    .settings-gear {
      position: absolute;
      top: 14px; right: 16px;
      width: 32px; height: 32px;
      background: rgba(255,255,255,0.25);
      border: none;
      border-radius: 50%;
      color: white;
      font-size: 16px;
      cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      transition: background 0.2s;
    }
    .settings-gear:hover { background: rgba(255,255,255,0.4); }

    /* Profile avatar overlap */
    .profile-info-wrap {
      padding: 0 20px 16px;
      text-align: center;
      margin-top: -44px;
      position: relative;
      z-index: 2;
    }
  </style>
</head>
<body>
<div class="phone-frame">

  <!--PAGE: LOGIN-->
  <div class="page active" id="page-login">
    <div class="login-page">
      <div class="login-header">
        <div class="login-logo">Grouper</div>
        <div class="login-tagline">Student Collaboration Platform</div>
      </div>

      <div class="form-group">
        <label class="form-label" for="login-email">University Email</label>
        <input class="form-input" type="email" id="login-email" placeholder="mart3490@mylaurier.ca">
        <div class="error-text" id="login-email-err">Please enter a valid university email.</div>
      </div>

      <div class="form-group">
        <label class="form-label" for="login-pass">Password</label>
        <input class="form-input" type="password" id="login-pass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
        <div class="error-text" id="login-pass-err">Password must be at least 6 characters.</div>
      </div>

      <div class="forgot-link"><a href="#">Forgot Password?</a></div>
      <button class="btn btn-primary" style="margin-bottom:12px;" id="btn-login">Log In</button>
      <button class="btn btn-outline" id="btn-register">Create Account</button>
      <div class="divider">or continue with</div>
      <button class="btn-microsoft" id="btn-ms">
        <div class="ms-grid">
          <div class="ms-tile" style="background:#f25022"></div>
          <div class="ms-tile" style="background:#7fba00"></div>
          <div class="ms-tile" style="background:#00a4ef"></div>
          <div class="ms-tile" style="background:#ffb900"></div>
        </div>
        Sign in with Microsoft
      </button>
    </div>
  </div>


  <!--PAGE: MAIN SHELL-->
  <div class="page" id="page-main">

    <!-- TAB: HOME -->
    <div class="tab-panel active" id="tab-home">
      <div class="top-bar">
        <div class="top-bar-row">
          <div class="app-logo">Grouper</div>
          <button class="icon-btn" id="btn-bell">üîî<span class="notif-dot"></span></button>
        </div>
        <div class="search-row">
          <input class="search-input" id="search-input" type="text" placeholder="Search by course, title, or skill‚Ä¶">
          <button class="filter-btn" id="btn-filter">‚öôÔ∏è</button>
        </div>
        <div id="filter-panel">
          <input type="text" id="filter-course-input" placeholder="Filter by course code (e.g. CP476)">
          <div class="filter-actions">
            <button class="btn btn-primary btn-sm" style="flex:1;" id="btn-filter-apply">Apply</button>
            <button class="btn btn-ghost btn-sm" id="btn-filter-clear">Clear</button>
          </div>
        </div>
      </div>

      <div class="notif-panel" id="notif-panel">
        <div class="notif-panel-header">Notifications <span class="notif-badge">2</span></div>
        <div class="notif-item" id="notif-req-item">
          <div class="notif-item-title">Kyler Smart wants to join your group</div>
          <div class="notif-item-sub">CP476 ‚Äì Project Grouper ‚Ä¢ just now</div>
        </div>
        <div class="notif-item">
          <div class="notif-item-title">Your request to CP363 is pending</div>
          <div class="notif-item-sub">Database Design Project ‚Ä¢ 2h ago</div>
        </div>
      </div>

      <div class="scroll-area">
        <div class="section-label">Suggested For You</div>
        <div id="feed-list"></div>
      </div>
      <button class="fab" id="btn-create">+</button>
    </div>

    <!-- TAB: MY GROUPS -->
    <div class="tab-panel" id="tab-groups">
      <div class="top-bar" style="padding-bottom:18px;">
        <div class="top-bar-row" style="margin-bottom:0;">
          <div class="app-logo" style="font-size:20px;">My Groups</div>
          <button class="icon-btn" id="btn-rate-groups" title="Rate teammates">‚≠ê</button>
        </div>
      </div>
      <div class="scroll-area">
        <div class="section-label">Groups I Manage</div>
        <div id="my-managing"></div>
        <div class="section-label" style="margin-top:4px;">Active Memberships</div>
        <div id="my-memberships"></div>
        <div class="section-label" style="margin-top:4px;">Sent Applications</div>
        <div id="my-applications"></div>
      </div>
    </div>

    <!-- TAB: PROFILE -->
    <div class="tab-panel" id="tab-profile">
      <div class="profile-banner">
        <button class="settings-gear" id="btn-settings">‚öôÔ∏è</button>
      </div>
      <div class="profile-info-wrap">
        <div class="avatar-xl" id="profile-initials">D</div>
        <div class="profile-name" id="profile-name">Drake Martin</div>
        <div class="profile-sub"  id="profile-sub">Computer Science ‚Ä¢ Year 4</div>
      </div>
      <div class="vouch-card">
        <div>
          <div class="vouch-score-num" id="vouch-score">18</div>
          <div class="vouch-score-label">Reliability Score</div>
        </div>
        <button class="btn-vouch" id="btn-rate-profile"><span>‚≠ê</span> Rate Teammates</button>
      </div>
      <div class="scroll-area" style="padding-top:4px;">
        <div class="section-title-inline">Technical Skills</div>
        <div class="skills-wrap" id="profile-skills"></div>
        <div class="section-title-inline">About Me</div>
        <div class="bio-box" id="profile-bio"></div>
        <div class="contact-row"><span>üìß</span><span id="profile-email"></span></div>
        <div class="contact-row"><span>üîó</span><span id="profile-github"></span></div>
      </div>
    </div>

    <!-- BOTTOM NAV -->
    <nav class="bottom-nav">
      <div class="nav-item active" data-tab="tab-home"><span class="nav-icon">üè†</span>Home</div>
      <div class="nav-item"        data-tab="tab-groups"><span class="nav-icon">üë•</span>My Groups</div>
      <div class="nav-item"        data-tab="tab-profile"><span class="nav-icon">üë§</span>Profile</div>
    </nav>
  </div>


  <!--PAGE: GROUP DETAIL-->
  <div class="page" id="page-detail">
    <div class="nav-header">
      <button class="back-btn" id="btn-back-detail">‚Üê</button>
      <div class="nav-title">Group Details</div>
    </div>
    <div class="scroll-area" style="padding-bottom:80px;">
      <div class="detail-card">
        <span class="course-badge" id="detail-course-badge"></span>
        <div class="detail-title"  id="detail-title"></div>
        <div class="meta-row"      id="detail-meta"></div>
        <div class="detail-desc"   id="detail-desc"></div>
        <div class="tags-row"      id="detail-tags"></div>
      </div>
      <div class="section-label">Current Members</div>
      <div class="member-list" id="detail-members"></div>
    </div>
    <div class="sticky-footer" id="detail-footer"></div>

    <!-- Join modal -->
    <div class="modal-overlay" id="join-modal">
      <div class="modal-sheet">
        <div class="sheet-drag"></div>
        <div class="sheet-title">Request to Join Group</div>
        <div class="sheet-sub">Send a short message about why you're a good fit.</div>
        <textarea class="form-textarea" id="join-note"
          placeholder="Hi! I have experience with Tailwind and would love to help with the frontend‚Ä¶"
          style="margin-bottom:14px;"></textarea>
        <button class="btn btn-success" id="btn-send-req">Send Request</button>
        <button class="btn btn-ghost"   id="btn-cancel-req" style="margin-top:8px;width:100%;">Cancel</button>
      </div>
    </div>
  </div>


  <!--PAGE: CREATE LISTING -->
  <div class="page" id="page-create">
    <div class="modal-header">
      <button class="modal-cancel" id="btn-cancel-create">Cancel</button>
      <span class="modal-title">Create Listing</span>
      <button class="modal-post"   id="btn-post-create">Post</button>
    </div>
    <div class="scroll-area">
      <div class="form-group">
        <label class="form-label">Course Code</label>
        <input class="form-input" id="create-course" type="text" placeholder="e.g. CP476" style="text-transform:uppercase;">
        <div class="helper-text">Must match a valid WLU course code (2 letters + 3 digits).</div>
        <div class="error-text" id="create-course-err">Please enter a valid course code (e.g. CP476).</div>
      </div>
      <div class="form-group">
        <label class="form-label">Project Title</label>
        <input class="form-input" id="create-title" type="text" placeholder="e.g. Mobile App for Students">
        <div class="error-text" id="create-title-err">Project title is required.</div>
      </div>
      <div class="form-group">
        <label class="form-label">Description</label>
        <textarea class="form-textarea" id="create-desc"
          placeholder="Describe your project idea, timeline, and what kind of partners you are looking for‚Ä¶"></textarea>
      </div>
      <div class="form-group">
        <label class="form-label">Total Team Size</label>
        <div class="stepper">
          <button class="stepper-btn" id="btn-size-dec">‚àí</button>
          <span class="stepper-val"   id="create-size-val">4</span>
          <button class="stepper-btn" id="btn-size-inc">+</button>
        </div>
        <div class="helper-text">Includes yourself.</div>
      </div>
      <div class="form-group">
        <label class="form-label">Required Skills</label>
        <div class="tag-input-wrap" id="tag-input-wrap">
          <input class="tag-typer" id="tag-typer" type="text" placeholder="Type a skill and press Enter‚Ä¶">
        </div>
        <div class="helper-text">Press Enter or comma to add a skill tag.</div>
      </div>
    </div>
  </div>


  <!--PAGE: RATE TEAMMATES -->
  <div class="page" id="page-rating">
    <div class="nav-header">
      <button class="back-btn" id="btn-back-rating">‚Üê</button>
      <div class="nav-title">Rate Teammates</div>
    </div>
    <div style="background:var(--white);padding:14px 20px;border-bottom:1px solid var(--grey-5);flex-shrink:0;">
      <div style="font-size:13px;color:var(--grey-3);line-height:1.5;">
        Vouch for teammates you'd work with again. Each vouch adds to their reliability score.
      </div>
    </div>
    <div class="scroll-area">
      <div class="section-label">Recent: CP476 Project</div>
      <div id="rating-list"></div>
    </div>
  </div>

  <!-- Settings panel (phone-frame child, overlays profile) -->
  <div id="settings-panel">
    <div class="settings-sheet">
      <div class="sheet-drag"></div>
      <div style="font-size:16px;font-weight:700;margin-bottom:8px;">Settings</div>
      <div class="settings-row settings-stub"><span class="settings-icon">‚úèÔ∏è</span> Edit Profile</div>
      <div class="settings-row settings-stub"><span class="settings-icon">üîî</span> Notification Preferences</div>
      <div class="settings-row settings-stub"><span class="settings-icon">üîí</span> Change Password</div>
      <div class="settings-row settings-stub"><span class="settings-icon">‚ùì</span> Help & Support</div>
      <div class="settings-row danger" id="btn-logout"><span class="settings-icon">üö™</span> Log Out</div>
    </div>
  </div>

</div><!-- /phone-frame -->

<script>
'use strict';

/* MOCK DATA */
const MOCK = {
  currentUser: {
    userID: 1, fName: 'Drake', lName: 'Martin',
    email: 'mart3490@mylaurier.ca', userYear: 4,
    majorID: 'Computer Science', score: 18,
    about: "I'm a senior CS student focusing on full-stack web development. I have experience with MERN stack and I'm looking for a group for CP476 that aims for an A+.\n\nAvailable on weekends and Tuesday/Thursday evenings.",
    github: 'github.com/dmartin',
    skills: ['Python', 'JavaScript', 'React.js', 'SQL', 'Figma'],
  },
  groups: [
    {
      groupID: 1, courseCode: 'CP476',
      title: 'Web Dev Project: E-Commerce',
      aboutGroup: 'Looking for a frontend developer familiar with React and Tailwind. We have backend covered.',
      userCount: 2, userMax: 4, dueDate: 'Apr 10',
      skills: ['JavaScript', 'React', 'Tailwind CSS'],
      members: [
        { userID:2,  fName:'Paul',  lName:'Matsialko', role:'Leader ‚Ä¢ Backend',  initials:'P', color:'avatar-purple' },
        { userID:3,  fName:'Kyler', lName:'Smart',     role:'Member ‚Ä¢ Database', initials:'K', color:'avatar-teal'   },
      ],
    },
    {
      groupID: 2, courseCode: 'CP317',
      title: 'Software Engineering ‚Äì SRS Docs',
      aboutGroup: 'Need one more person for documentation and QA testing. Easy going group.',
      userCount: 3, userMax: 4, dueDate: 'Mar 20',
      skills: ['Jira', 'Testing', 'Documentation'],
      members: [
        { userID:4, fName:'Alex', lName:'Thompson', role:'Leader',        initials:'A', color:'avatar-blue'   },
        { userID:5, fName:'Sara', lName:'Nguyen',   role:'Member ‚Ä¢ QA',   initials:'S', color:'avatar-orange' },
        { userID:6, fName:'Liam', lName:'Chen',     role:'Member ‚Ä¢ Docs', initials:'L', color:'avatar-purple' },
      ],
    },
    {
      groupID: 3, courseCode: 'CP363',
      title: 'Database Design Project',
      aboutGroup: 'Full group established. Just posting for visibility.',
      userCount: 4, userMax: 4, dueDate: 'Mar 28',
      skills: ['SQL', 'PHP', 'MySQL'],
      members: [
        { userID:7,  fName:'Mia',  lName:'Park',   role:'Leader', initials:'M', color:'avatar-teal'   },
        { userID:8,  fName:'Tom',  lName:'Davis',  role:'Member', initials:'T', color:'avatar-orange' },
        { userID:9,  fName:'Nina', lName:'Reyes',  role:'Member', initials:'N', color:'avatar-blue'   },
        { userID:10, fName:'Jake', lName:'Wilson', role:'Member', initials:'J', color:'avatar-purple' },
      ],
    },
    {
      groupID: 4, courseCode: 'CP104',
      title: 'Intro to Programming ‚Äì Study Group',
      aboutGroup: 'First year student looking for partners to study with and tackle assignments together.',
      userCount: 1, userMax: 3, dueDate: 'Ongoing',
      skills: ['Python'],
      members: [
        { userID:11, fName:'Priya', lName:'Kumar', role:'Leader', initials:'P', color:'avatar-orange' },
      ],
    },
  ],
  managedGroup: {
    groupID:5, courseCode:'CP476', title:'Project Grouper',
    userMax: 4,
    members: [
      { userID:1,  fName:'Drake', lName:'Martin',    initials:'D', color:'avatar-teal'   },
      { userID:3,  fName:'Josh',  lName:'Gelbaum',   initials:'J', color:'avatar-purple' },
    ],
    requests: [
      { reqID:1, userID:12, fName:'Kyler', lName:'Smart',     initials:'K', color:'avatar-teal',   message:'"I know backend dev!"' },
      { reqID:2, userID:13, fName:'Paul',  lName:'Matsialko', initials:'P', color:'avatar-purple', message:'Year 4 Student'        },
    ],
  },
  memberships:  [ { groupID:2, courseCode:'CP317', title:'SRS Documentation Team'  } ],
  applications: [ { groupID:3, courseCode:'CP363', title:'Database Design Project', status:'pending' } ],
  teammates: [
    { userID:3, fName:'Josh',  lName:'Gelbaum',   role:'Frontend Dev',       initials:'J', color:'avatar-blue',   vouched:false },
    { userID:4, fName:'Kyler', lName:'Smart',     role:'Database Architect', initials:'K', color:'avatar-teal',   vouched:true  },
    { userID:5, fName:'Paul',  lName:'Matsialko', role:'Project Lead',       initials:'P', color:'avatar-orange', vouched:false },
  ],
};

/* STATE */
const STATE = {
  searchQuery:   '',
  filterCourse:  '',
  selectedGroup: null,
  vouchedIDs:    new Set(MOCK.teammates.filter(t => t.vouched).map(t => t.userID)),
  activeTab:     'tab-home',
};

/*UTILITIES */
const $ = id => document.getElementById(id);

function showToast(msg) {
  document.querySelectorAll('.toast').forEach(t => t.remove());
  const t = document.createElement('div');
  t.className = 'toast';
  t.textContent = msg;
  document.querySelector('.phone-frame').appendChild(t);
  setTimeout(() => t.remove(), 2700);
}

function slotStatus(g) {
  if (g.userCount >= g.userMax) return 'full';
  if (g.userCount / g.userMax >= 0.75) return 'warn';
  return 'open';
}
function slotBadge(g) {
  return g.userCount >= g.userMax ? 'Full' : `${g.userCount}/${g.userMax} Members`;
}

/* NAVIGATION  ‚Äî one function, no conflicts */
function showPage(pageId) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  $(pageId).classList.add('active');
}

function switchTab(tabId) {
  STATE.activeTab = tabId;
  document.querySelectorAll('.tab-panel').forEach(t => t.classList.remove('active'));
  $(tabId).classList.add('active');
  document.querySelectorAll('.nav-item[data-tab]').forEach(n => {
    n.classList.toggle('active', n.dataset.tab === tabId);
  });
  if (tabId === 'tab-groups')  renderMyGroups();
  if (tabId === 'tab-profile') renderProfile();
}

function goToMain(tab) {
  showPage('page-main');
  switchTab(tab || STATE.activeTab);
}

/*LOGIN*/
function doLogin() {
  const email = $('login-email').value.trim();
  const pass  = $('login-pass').value.trim();
  let ok = true;

  if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
    $('login-email').classList.add('error');
    $('login-email-err').classList.add('show');
    ok = false;
  } else {
    $('login-email').classList.remove('error');
    $('login-email-err').classList.remove('show');
  }
  if (!pass || pass.length < 6) {
    $('login-pass').classList.add('error');
    $('login-pass-err').classList.add('show');
    ok = false;
  } else {
    $('login-pass').classList.remove('error');
    $('login-pass-err').classList.remove('show');
  }
  if (!ok) return;

  // POST /api/auth/login { email, hashPass }
  goToMain('tab-home');
  renderFeed();
}

/*HOME FEED */
function renderFeed() {
  const list = $('feed-list');
  let groups = [...MOCK.groups];
  const q = STATE.searchQuery.toLowerCase().trim();
  if (q) groups = groups.filter(g =>
    g.courseCode.toLowerCase().includes(q) ||
    g.title.toLowerCase().includes(q) ||
    g.skills.some(s => s.toLowerCase().includes(q))
  );
  if (STATE.filterCourse) groups = groups.filter(g => g.courseCode === STATE.filterCourse);

  if (!groups.length) {
    list.innerHTML = `
      <div style="text-align:center;padding:40px 20px;color:var(--grey-3);">
        <div style="font-size:36px;margin-bottom:10px;">üîç</div>
        <div style="font-size:15px;font-weight:600;margin-bottom:6px;">No groups found</div>
        <div style="font-size:13px;">Try a different search or clear filters.</div>
      </div>`;
    return;
  }

  list.innerHTML = groups.map(g => {
    const status = slotStatus(g);
    const tags   = g.skills.slice(0,3).map(s => `<span class="tag">${s}</span>`).join('');
    return `
      <div class="group-card ${status}" data-gid="${g.groupID}">
        <div class="card-top">
          <span class="course-code">${g.courseCode}</span>
          <span class="slots-badge ${status}">${slotBadge(g)}</span>
        </div>
        <div class="card-title">${g.title}</div>
        <div class="card-desc">${g.aboutGroup}</div>
        <div class="tags-row">${tags}</div>
        <button class="btn btn-outline btn-sm" style="pointer-events:none;">View Details ‚Üí</button>
      </div>`;
  }).join('');

  list.querySelectorAll('.group-card').forEach(card => {
    card.addEventListener('click', () => openGroupDetail(parseInt(card.dataset.gid)));
  });
}

/*GROUP DETAIL*/
function openGroupDetail(groupID) {
  const g = MOCK.groups.find(x => x.groupID === groupID);
  if (!g) return;
  STATE.selectedGroup = g;

  $('detail-course-badge').textContent = g.courseCode;
  $('detail-title').textContent        = g.title;
  $('detail-meta').innerHTML  = `<span>üìÖ Due: ${g.dueDate}</span><span>üë• ${slotBadge(g)}</span>`;
  $('detail-desc').textContent         = g.aboutGroup;
  $('detail-tags').innerHTML           = g.skills.map(s => `<span class="tag">${s}</span>`).join('');

  const open = g.userMax - g.members.length;
  $('detail-members').innerHTML =
    g.members.map(m => `
      <div class="member-item">
        <div class="avatar ${m.color}">${m.initials}</div>
        <div class="member-info">
          <span class="member-name">${m.fName} ${m.lName}</span>
          <span class="member-role">${m.role}</span>
        </div>
      </div>`).join('') +
    Array.from({length: open}, () => `
      <div class="member-item" style="opacity:0.45;">
        <div class="avatar avatar-empty">?</div>
        <div class="member-info"><span class="member-name">Open Slot</span></div>
      </div>`).join('');

  if (g.userCount >= g.userMax) {
    $('detail-footer').innerHTML = `<button class="btn btn-ghost" style="width:100%;" disabled>Group is Full</button>`;
  } else {
    $('detail-footer').innerHTML = `<button class="btn btn-primary" id="btn-open-join">Request to Join</button>`;
    $('btn-open-join').addEventListener('click', openJoinModal);
  }

  showPage('page-detail');
}

/* JOIN MODAL */
function openJoinModal() {
  $('join-note').value = '';
  $('join-note').style.borderColor = '';
  $('join-modal').classList.add('open');
  setTimeout(() => $('join-note').focus(), 80);
}
function closeJoinModal() { $('join-modal').classList.remove('open'); }

function submitJoinRequest() {
  const note = $('join-note').value.trim();
  if (!note) { $('join-note').style.borderColor = 'var(--red)'; return; }
  // POST /api/requests { groupID, message }
  closeJoinModal();
  const g = STATE.selectedGroup;
  if (g) MOCK.applications.push({ groupID:g.groupID, courseCode:g.courseCode, title:g.title, status:'pending' });
  showToast('‚úÖ Request sent!');
}

/* MY GROUP */
function renderMyGroups() {
  const mg = MOCK.managedGroup;

  const membersHtml = mg.members.map(m => `
    <div class="roster-row">
      <div class="avatar ${m.color}" style="width:28px;height:28px;font-size:11px;">${m.initials}</div>
      <span class="roster-name">${m.fName} ${m.lName}</span>
    </div>`).join('');

  const reqsHtml = mg.requests.map(r => `
    <div class="req-item" id="req-${r.reqID}">
      <div>
        <div class="req-name">${r.fName} ${r.lName}</div>
        <div class="req-sub">${r.message}</div>
      </div>
      <div class="req-actions">
        <button class="btn-approve" data-reqid="${r.reqID}" data-action="approve">‚úî</button>
        <button class="btn-decline" data-reqid="${r.reqID}" data-action="decline">‚úñ</button>
      </div>
    </div>`).join('');

  $('my-managing').innerHTML = `
    <div class="manage-card">
      <div class="manage-card-header">
        <div>
          <div class="manage-group-name">${mg.courseCode} ‚Äì ${mg.title}</div>
          <div class="manage-group-sub">Managed by you</div>
        </div>
        <span class="role-badge">Leader</span>
      </div>
      <div class="roster-label">Current Roster (${mg.members.length}/${mg.userMax})</div>
      <div id="managed-roster">${membersHtml}</div>
      ${mg.requests.length > 0
        ? `<div class="request-box">
             <div class="req-box-header">‚ö†Ô∏è ${mg.requests.length} Request${mg.requests.length > 1 ? 's' : ''} Pending</div>
             ${reqsHtml}
           </div>`
        : `<div style="font-size:12px;color:var(--grey-3);margin-top:10px;">No pending requests.</div>`}
    </div>`;

  // Wire approve/decline buttons
  $('my-managing').querySelectorAll('[data-reqid]').forEach(btn => {
    btn.addEventListener('click', () => handleRequest(+btn.dataset.reqid, btn.dataset.action));
  });

  $('my-memberships').innerHTML = MOCK.memberships.map(g => `
    <div class="manage-card" style="border-top-color:var(--grey-4);">
      <div class="manage-card-header" style="border:none;margin:0;padding:0;">
        <div><div class="manage-group-name">${g.courseCode} ‚Äì ${g.title}</div></div>
        <span class="role-badge member">Member</span>
      </div>
    </div>`).join('');

  $('my-applications').innerHTML = MOCK.applications.length
    ? MOCK.applications.map(a => `
        <div class="pending-card">
          <div>
            <div class="manage-group-name">${a.courseCode} ‚Äì ${a.title}</div>
            <div style="font-size:12px;color:var(--grey-3);">Waiting for leader...</div>
          </div>
          <span class="pending-status">Pending</span>
        </div>`).join('')
    : `<div style="font-size:13px;color:var(--grey-3);">No pending applications.</div>`;
}

function handleRequest(reqID, action) {
  const mg  = MOCK.managedGroup;
  const idx = mg.requests.findIndex(r => r.reqID === reqID);
  if (idx === -1) return;
  const req = mg.requests[idx];

  if (action === 'approve') {
    // PATCH /api/requests/:reqID { status: 'accepted' }
    mg.members.push({ userID:req.userID, fName:req.fName, lName:req.lName, initials:req.initials, color:req.color });
    showToast(`‚úÖ ${req.fName} ${req.lName} added to your group!`);
  } else {
    // PATCH /api/requests/:reqID { status: 'rejected' }
    showToast(`‚úñ ${req.fName} ${req.lName} declined.`);
  }

  mg.requests.splice(idx, 1); // remove from pending list
  renderMyGroups();
}

/*PROFILE*/
function renderProfile() {
  const u = MOCK.currentUser;
  $('profile-initials').textContent = u.fName[0];
  $('profile-name').textContent     = `${u.fName} ${u.lName}`;
  $('profile-sub').textContent      = `${u.majorID} ‚Ä¢ Year ${u.userYear}`;
  $('vouch-score').textContent      = u.score;
  $('profile-email').textContent    = u.email;
  $('profile-github').textContent   = u.github;
  $('profile-skills').innerHTML     = u.skills.map(s => `<span class="skill-tag">${s}</span>`).join('');
  $('profile-bio').textContent      = u.about;
}

/* RATE TEAMMATES*/
function renderRating() {
  $('rating-list').innerHTML = MOCK.teammates.map(t => {
    const done = STATE.vouchedIDs.has(t.userID);
    return `
      <div class="rate-card">
        <div class="rate-avatar ${t.color}">${t.initials}</div>
        <div class="rate-info">
          <span class="rate-name">${t.fName} ${t.lName}</span>
          <span class="rate-role">${t.role}</span>
        </div>
        <button class="btn-vouch ${done ? 'vouched' : ''}" data-uid="${t.userID}" data-name="${t.fName}" ${done ? 'disabled' : ''}>
          ${done ? '<span>‚úî</span> Vouched' : '<span>üëç</span> Vouch'}
        </button>
      </div>`;
  }).join('');

  $('rating-list').querySelectorAll('.btn-vouch:not(.vouched)').forEach(btn => {
    btn.addEventListener('click', () => {
      const uid = +btn.dataset.uid;
      if (STATE.vouchedIDs.has(uid)) return;
      // POST /api/users/:uid/vouch
      STATE.vouchedIDs.add(uid);
      showToast(`You vouched for ${btn.dataset.name}!`);
      renderRating();
    });
  });
}

/* CREATE LISTING */
let createTags = [];

function renderTagChips() {
  const wrap  = $('tag-input-wrap');
  const typer = $('tag-typer');
  wrap.querySelectorAll('.tag-chip').forEach(c => c.remove());
  createTags.forEach((tag, idx) => {
    const chip = document.createElement('span');
    chip.className = 'tag-chip';
    chip.innerHTML = `${tag} <span class="tag-chip-remove" data-idx="${idx}">√ó</span>`;
    wrap.insertBefore(chip, typer);
  });
  wrap.querySelectorAll('.tag-chip-remove').forEach(btn => {
    btn.addEventListener('click', () => { createTags.splice(+btn.dataset.idx, 1); renderTagChips(); });
  });
}

function openCreateListing() {
  $('create-course').value = '';
  $('create-title').value  = '';
  $('create-desc').value   = '';
  $('create-size-val').textContent = '4';
  $('create-course').classList.remove('error');
  $('create-title').classList.remove('error');
  $('create-course-err').classList.remove('show');
  $('create-title-err').classList.remove('show');
  createTags = [];
  renderTagChips();
  showPage('page-create');
}

function submitCreateListing() {
  const code  = $('create-course').value.trim().toUpperCase();
  const title = $('create-title').value.trim();
  const desc  = $('create-desc').value.trim();
  const size  = +$('create-size-val').textContent;
  let ok = true;

  if (!/^[A-Z]{2}\d{3}$/.test(code)) {
    $('create-course-err').classList.add('show'); $('create-course').classList.add('error'); ok = false;
  } else {
    $('create-course-err').classList.remove('show'); $('create-course').classList.remove('error');
  }
  if (!title) {
    $('create-title-err').classList.add('show'); $('create-title').classList.add('error'); ok = false;
  } else {
    $('create-title-err').classList.remove('show'); $('create-title').classList.remove('error');
  }
  if (!ok) return;

  // POST /api/groups { courseCode, title, aboutGroup, userMax, skills }
  const u = MOCK.currentUser;
  MOCK.groups.unshift({
    groupID: Date.now(), courseCode: code, title,
    aboutGroup: desc || 'No description provided.',
    userCount: 1, userMax: size, dueDate: 'TBD',
    skills: [...createTags],
    members: [{ userID:u.userID, fName:u.fName, lName:u.lName,
                role:'Leader', initials:u.fName[0], color:'avatar-teal' }],
  });

  goToMain('tab-home');
  renderFeed();
  showToast('Listing posted!');
}

/* INIT */
document.addEventListener('DOMContentLoaded', () => {

  // Login
  $('btn-login').addEventListener('click', doLogin);
  $('btn-ms').addEventListener('click', doLogin);
  $('btn-register').addEventListener('click', () => showToast('üìß Check your university email to verify.'));
  $('login-email').addEventListener('keydown', e => { if (e.key === 'Enter') doLogin(); });
  $('login-pass').addEventListener('keydown',  e => { if (e.key === 'Enter') doLogin(); });

  // Bottom nav
  document.querySelectorAll('.nav-item[data-tab]').forEach(item => {
    item.addEventListener('click', () => { showPage('page-main'); switchTab(item.dataset.tab); });
  });

  // Search
  $('search-input').addEventListener('input', e => { STATE.searchQuery = e.target.value; renderFeed(); });

  // Filter
  $('btn-filter').addEventListener('click', () => { $('filter-panel').classList.toggle('open'); });
  $('btn-filter-apply').addEventListener('click', () => {
    STATE.filterCourse = $('filter-course-input').value.trim().toUpperCase();
    $('filter-panel').classList.remove('open');
    renderFeed();
  });
  $('btn-filter-clear').addEventListener('click', () => {
    STATE.filterCourse = ''; $('filter-course-input').value = '';
    $('filter-panel').classList.remove('open');
    renderFeed();
  });

  // Bell / notifications
  $('btn-bell').addEventListener('click', e => { e.stopPropagation(); $('notif-panel').classList.toggle('open'); });
  $('notif-req-item').addEventListener('click', () => {
    $('notif-panel').classList.remove('open');
    goToMain('tab-groups');
  });
  document.addEventListener('click', e => {
    if (!$('notif-panel').contains(e.target) && e.target !== $('btn-bell'))
      $('notif-panel').classList.remove('open');
  });

  // FAB ‚Üí create
  $('btn-create').addEventListener('click', openCreateListing);

  // Back buttons
  $('btn-back-detail').addEventListener('click', () => goToMain());
  $('btn-back-rating').addEventListener('click', () => goToMain());

  // Join modal
  $('btn-send-req').addEventListener('click', submitJoinRequest);
  $('btn-cancel-req').addEventListener('click', closeJoinModal);

  // Create listing
  $('btn-cancel-create').addEventListener('click', () => goToMain());
  $('btn-post-create').addEventListener('click', submitCreateListing);
  $('btn-size-dec').addEventListener('click', () => {
    const e = $('create-size-val'); e.textContent = Math.max(2, +e.textContent - 1);
  });
  $('btn-size-inc').addEventListener('click', () => {
    const e = $('create-size-val'); e.textContent = Math.min(10, +e.textContent + 1);
  });
  $('tag-input-wrap').addEventListener('click', () => $('tag-typer').focus());
  $('tag-typer').addEventListener('keydown', e => {
    const val = $('tag-typer').value.trim().replace(/,/g,'');
    if ((e.key === 'Enter' || e.key === ',') && val) {
      e.preventDefault();
      if (!createTags.includes(val)) { createTags.push(val); renderTagChips(); }
      $('tag-typer').value = '';
    } else if (e.key === 'Backspace' && !$('tag-typer').value && createTags.length) {
      createTags.pop(); renderTagChips();
    }
  });

  // Rate teammates
  $('btn-rate-groups').addEventListener('click',  () => { renderRating(); showPage('page-rating'); });
  $('btn-rate-profile').addEventListener('click', () => { renderRating(); showPage('page-rating'); });

  // Settings
  $('btn-settings').addEventListener('click', e => {
    e.stopPropagation();
    $('settings-panel').classList.add('open');
  });
  $('settings-panel').addEventListener('click', e => {
    if (e.target === $('settings-panel')) $('settings-panel').classList.remove('open');
  });
  document.querySelectorAll('.settings-stub').forEach(row => {
    row.addEventListener('click', () => { $('settings-panel').classList.remove('open'); showToast('‚öôÔ∏è Coming soon!'); });
  });
  $('btn-logout').addEventListener('click', () => {
    $('settings-panel').classList.remove('open');
    $('login-email').value = '';
    $('login-pass').value  = '';
    showPage('page-login');
    showToast('Logged out.');
  });

});
</script>
</body>
</html>
